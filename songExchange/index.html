<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ­Œæ›²äº¤æ›</title>

  <!-- Firebase SDK (compat ç‰ˆæœ¬ï¼Œæ”¯æ´èˆŠå¯«æ³•) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 400px;
      margin: 40px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      background: #007bff;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #0056d2;
    }

    #status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      font-size: 16px;
      display: none;
    }

    .error { background: #ffdddd; border: 1px solid #ff8888; }
    .success { background: #ddffdd; border: 1px solid #88cc88; }
  </style>
</head>

<body>

  <h2>å¡«ä¸€é¦–ä½ æ¨è–¦çš„æ­Œèˆ‡æ­Œåº«äº¤æ›ğŸµ </h2>

  <label>æ­Œåï¼š</label>
  <input id="songNameInput" type="text" placeholder="è¼¸å…¥æ­Œå">

  <label>æ­Œæ‰‹ï¼š</label>
  <input id="artistInput" type="text" placeholder="è¼¸å…¥æ­Œæ‰‹">

  <button onclick="submitSong()">æäº¤</button>

  <div id="status"></div>

  <script>
    /* ---------------------------
       Firebase è¨­å®š
    ---------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyDl7MRgN9kYxJKPgb_3Q8C4HcznFsO-rdI",
      authDomain: "shuffle-song-suggestions.firebaseapp.com",
      projectId: "shuffle-song-suggestions",
      storageBucket: "shuffle-song-suggestions.appspot.com",
      messagingSenderId: "92017531680",
      appId: "1:92017531680:web:358a69edcb70cb4b7c1545"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ---------------------------
       ä¸»åŠŸèƒ½ï¼šæäº¤æ­Œå (Transaction ç‰ˆæœ¬)
    ---------------------------- */
    async function submitSong() {
      const songName = document.getElementById("songNameInput").value.trim();
      const artist = document.getElementById("artistInput").value.trim();
      const statusBox = document.getElementById("status");

      if (!songName || !artist) {
        showStatus("è«‹å¡«å¯«å®Œæ•´çš„æ­Œåèˆ‡æ­Œæ‰‹ï¼", "error");
        return;
      }

      try {
        await db.runTransaction(async (transaction) => {
          const songListRef = db.collection("SongList");

          // 1. æª¢æŸ¥æ˜¯å¦é‡è¤‡
          const duplicateQuery = await transaction.get(
            songListRef
              .where("songname", "==", songName)
              .where("artist", "==", artist)
          );

          if (!duplicateQuery.empty) {
            throw new Error("duplicate");
          }

          // 2. è®€å–æ•´å€‹æ­Œå–® â†’ æ‰¾æœ€å¤§ songId
          const allSongsSnapshot = await transaction.get(songListRef);
          let maxId = 0;
          const songs = [];
          allSongsSnapshot.forEach(doc => {
            const data = doc.data();
            songs.push(data);
            if (data.songId && data.songId > maxId) maxId = data.songId;
          });

          const newId = maxId + 1;

          // 3. éš¨æ©ŸæŠ½æ­Œ
          let randomSong = null;
          if (songs.length > 0) {
            randomSong = songs[Math.floor(Math.random() * songs.length)];
          }

          // 4. æ–°å¢æ–‡ä»¶ï¼ŒID ç”¨ newId
          transaction.set(songListRef.doc(String(newId)), {
            songId: newId,
            songname: songName,
            artist: artist
          });

          // 5. é¡¯ç¤ºæ¨è–¦æ­Œæ›²
          if (randomSong) {
            showStatus(
              `ğŸ‰ è¬è¬ï¼ä½ çš„æ¨è–¦å·²åŠ å…¥æ­Œå–®ï¼<br>` +
              `ä½ æŠ½åˆ°çš„æ¨è–¦æ­Œæ›²æ˜¯ï¼š<b>${randomSong.songname} - ${randomSong.artist}</b>`,
              "success"
            );
          } else {
            showStatus(
              `ğŸ‰ è¬è¬ï¼ä½ çš„æ¨è–¦å·²åŠ å…¥æ­Œå–®ï¼<br>ç›®å‰æ­Œå–®é‚„æ²’æœ‰å…¶ä»–æ­Œæ›²å¯ä»¥æŠ½ï¼`,
              "success"
            );
          }

          // æ¸…ç©ºè¼¸å…¥æ¬„
          document.getElementById("songNameInput").value = "";
          document.getElementById("artistInput").value = "";

        });
      } catch (err) {
        if (err.message === "duplicate") {
          showStatus("âŒ é€™é¦–æ­Œå·²ç¶“åœ¨æ­Œå–®ä¸­ï¼Œè«‹æ›ä¸€é¦–ï¼", "error");
        } else {
          console.error(err);
          showStatus("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        }
      }
    }

    /* ---------------------------
       é¡¯ç¤ºè¨Šæ¯
    ---------------------------- */
    function showStatus(msg, type) {
      const box = document.getElementById("status");
      box.style.display = "block";
      box.className = type;
      box.innerHTML = msg;
    }
  </script>

</body>
</html>
